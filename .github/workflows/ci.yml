name: CI

on:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    container: swift:latest
    steps:
      - uses: actions/checkout@v5
      - run: swift format lint -r -p -s .
  test:
    runs-on: ubuntu-latest
    env:
      APPLE_APP_ID: XXXXXXXX.com.apple.memo
      VALKEY_HOSTNAME: valkey
      POSTGRES_HOSTNAME: postgres
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: test_database
      EdDSA_PRIVATE_KEY: T8s3Xh9Aulyq0UqIkggCgDyyXQKzPgIWH0w4Cb1O3Yg=
      RELYING_PARTY_ORIGIN: http://localhost:8080
      RELYING_PARTY_ID: localhost
      RELYING_PARTY_NAME: Local Host Relying Party
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Start DB & Cache (wait for health)
        run: docker compose up -d --wait postgres valkey
      - name: Run tests (Swift in Docker)
        run: docker compose run --rm swift bash -lc "swift test --parallel"
      - name: Shutdown
        run: docker compose down -v
